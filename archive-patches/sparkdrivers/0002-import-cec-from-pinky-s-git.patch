From 5eba0883ad517d39c069a5567d1d602bb9cb989e Mon Sep 17 00:00:00 2001
From: Stefan Seyfried <seife@tuxbox-git.slipkontur.de>
Date: Fri, 6 Jul 2012 14:50:02 +0200
Subject: [PATCH 2/2] import cec from pinky's git

git://gitorious.org/~pinky1981/open-duckbox-project-sh4/pingulux-git.git
commit 6d6486c89a5e4c0828ed0502f45b2b9c5b5f53ce
---
 Makefile               |    1 +
 cec/Makefile           |    5 ++++
 cec/cec_dev.c          |    3 ++
 cec/cec_main.c         |   15 ++++++++++++
 cec/cec_opcodes.c      |   58 +++++++++++++++++++++++++++++++++++++++++++++++-
 cec/cec_opcodes_def.h  |   11 +++++++++
 cec/cec_rc.c           |   14 +++++++++++
 e2_proc/e2_proc_main.c |    2 +-
 8 files changed, 107 insertions(+), 2 deletions(-)

diff --git a/Makefile b/Makefile
index 971061d..1db160b 100644
--- a/Makefile
+++ b/Makefile
@@ -221,6 +221,7 @@ endif
 ifdef SPARK
 obj-y	+= smartcard/
 obj-y	+= cpu_frequ/
+obj-y	+= cec/
 endif
 
 ifdef SPARK7162
diff --git a/cec/Makefile b/cec/Makefile
index bc7a170..514409b 100644
--- a/cec/Makefile
+++ b/cec/Makefile
@@ -6,6 +6,7 @@ obj-m           += cec.o
 cec-objs        += cec_main.o cec_worker.o cec_opcodes.o cec_internal.o cec_proc.o cec_rc.o cec_dev.o
 
 EXTRA_CFLAGS    := -I$(DRIVER_TOPDIR)/cec -I$(DRIVER_TOPDIR)/include -I$(DRIVER_TOPDIR)/dvb/drivers/media/dvb
+EXTRA_CFLAGS	+= -DEVOLUX
 
 ifdef UFS912
 EXTRA_CFLAGS	+= -DSTx7111
@@ -15,6 +16,10 @@ ifdef UFS913
 EXTRA_CFLAGS	+= -DSTx7105
 endif
 
+ifdef SPARK
+EXTRA_CFLAGS	+= -DSTx7111
+endif
+
 ifdef HS7810A
 EXTRA_CFLAGS	+= -DSTx7111
 endif
diff --git a/cec/cec_dev.c b/cec/cec_dev.c
index 5fa3baa..0822037 100644
--- a/cec/cec_dev.c
+++ b/cec/cec_dev.c
@@ -265,6 +265,9 @@ int init_dev(void)
 int cleanup_dev(void)
 {
 	unregister_chrdev(CEC_MAJOR,"CEC");
+#ifdef EVOLUX
+	return 0;
+#endif
 }
 
 
diff --git a/cec/cec_main.c b/cec/cec_main.c
index 60223ff..d546acd 100644
--- a/cec/cec_main.c
+++ b/cec/cec_main.c
@@ -40,6 +40,9 @@
 #include "cec_debug.h"
 #include "cec_worker.h"
 #include "cec_opcodes.h"
+#ifdef EVOLUX
+#include "cec_opcodes_def.h"
+#endif
 #include "cec_internal.h"
 #include "cec_proc.h"
 #include "cec_rc.h"
@@ -49,6 +52,10 @@
 
 static unsigned char cancelStart = 0;
 int activemode = 0;
+#ifdef EVOLUX
+char *deviceName = "DUCKBOX";
+unsigned char deviceType = DEVICE_TYPE_DVD;
+#endif
 
 //----------------------------
 
@@ -134,6 +141,14 @@ MODULE_LICENSE          ("GPL");
 
 module_param(debug, int, S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP);
 module_param(activemode, int, S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP);
+#ifdef EVOLUX
+module_param(deviceType, byte, S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP);
+module_param(deviceName, charp, S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP);
+#endif
 MODULE_PARM_DESC(debug, "Debug Output 0=disabled >0=enabled(debuglevel)");
 MODULE_PARM_DESC(activemode, "Active mode 0=disabled >0=enabled(activemode)");
+#ifdef EVOLUX
+MODULE_PARM_DESC(deviceType, "Device type (default: 4 (DVD))");
+MODULE_PARM_DESC(deviceName, "Name (default: DUCKBOX)");
+#endif
 
diff --git a/cec/cec_opcodes.c b/cec/cec_opcodes.c
index 4e2b0b0..b7b0fba 100644
--- a/cec/cec_opcodes.c
+++ b/cec/cec_opcodes.c
@@ -52,6 +52,19 @@ static unsigned char isFirstKiss = 0;
 static unsigned char logicalDeviceTypeChoicesIndex = 0;
 
 
+#ifdef EVOLUX
+static const unsigned char logicalDeviceTypeChoices[][2] =  { 
+  { 1 << DEVICE_TYPE_DVD, DEVICE_TYPE_DVD1 }, 
+  { 1 << DEVICE_TYPE_DVD, DEVICE_TYPE_DVD2 }, 
+  { 1 << DEVICE_TYPE_DVD, DEVICE_TYPE_DVD3 }, 
+  { 1 << DEVICE_TYPE_STB, DEVICE_TYPE_STB1 }, 
+  { 1 << DEVICE_TYPE_STB, DEVICE_TYPE_STB2 }, 
+  { 1 << DEVICE_TYPE_STB, DEVICE_TYPE_STB3 },
+  { 1 << DEVICE_TYPE_REC, DEVICE_TYPE_REC1 },
+  { 1 << DEVICE_TYPE_REC, DEVICE_TYPE_REC2 },
+  { 0xFF, DEVICE_TYPE_UNREG }
+ };
+#else
 static const unsigned char logicalDeviceTypeChoices[] =  { 
 DEVICE_TYPE_DVD1, 
 DEVICE_TYPE_DVD2, 
@@ -62,9 +75,17 @@ DEVICE_TYPE_STB3,
 DEVICE_TYPE_REC1, //PREV_KEY_WORKING
 DEVICE_TYPE_REC2, 
 DEVICE_TYPE_UNREG };
+#endif
 
+#ifdef EVOLUX
+extern char *deviceName;
+#endif
 static unsigned char logicalDeviceType = DEVICE_TYPE_DVD1;
+#ifdef EVOLUX
+extern unsigned char deviceType;
+#else
 static unsigned char deviceType = DEVICE_TYPE_DVD;
+#endif
 
 static unsigned short ActiveSource = 0x0000;
 
@@ -94,7 +115,7 @@ unsigned char getDeviceType(void) {
 unsigned short getPhysicalAddress(void) {
   unsigned int value = 0;
   stmhdmiio_get_cec_address(&value);
-  
+
   return value & 0xffff;
 }
 
@@ -279,6 +300,16 @@ void parseMessage(unsigned char src, unsigned char dst, unsigned int len, unsign
         case USER_CONTROL_CODE_FUNCTION_POWER_TOGGLE:       strcat(name, "POWER_TOGGLE");        break;
         case USER_CONTROL_CODE_FUNCTION_POWER_OFF:          strcat(name, "POWER_OFF");           break;
         case USER_CONTROL_CODE_FUNCTION_POWER_ON:           strcat(name, "POWER_ON");            break;
+#ifdef EVOLUX
+	case USER_CONTROL_CODE_ROOT_MENU:	strcat(name, "ROOT_MENU");	break;
+	case USER_CONTROL_CODE_CONTENTS_MENU:	strcat(name, "CONTENTS_MENU");	break;
+	case USER_CONTROL_CODE_SETUP_MENU:	strcat(name, "SETUP_MENU");	break;
+	case USER_CONTROL_CODE_PAGEUP:		strcat(name, "PAGEUP");		break;
+	case USER_CONTROL_CODE_PAGEDOWN:	strcat(name, "PAGEDOWN");	break;
+	case USER_CONTROL_CODE_INFO:		strcat(name, "INFO");		break;
+	case USER_CONTROL_CODE_NEXT:		strcat(name, "NEXT");		break;
+	case USER_CONTROL_CODE_LAST:		strcat(name, "LAST");		break;
+#endif
         default: break;
       }
 
@@ -305,6 +336,15 @@ void parseMessage(unsigned char src, unsigned char dst, unsigned int len, unsign
       {
       responseBuffer[0] = (getLogicalDeviceType() << 4) + (src & 0xF);
       responseBuffer[1] = SET_OSD_NAME;
+#ifdef EVOLUX
+      {
+	int len = strlen(deviceName);
+	if (len > CEC_MAX_DATA_LEN - 2)
+		len = CEC_MAX_DATA_LEN - 2;
+	strncpy(responseBuffer + 2, deviceName, len);
+	sendMessage(len + 2, responseBuffer);
+      }
+#else
       responseBuffer[2] = 'D';
       responseBuffer[3] = 'U';
       responseBuffer[4] = 'C'; 
@@ -313,6 +353,7 @@ void parseMessage(unsigned char src, unsigned char dst, unsigned int len, unsign
       responseBuffer[7] = 'O'; 
       responseBuffer[8] = 'X'; 
       sendMessage(9, responseBuffer);
+#endif
       }
       break;
 
@@ -637,14 +678,29 @@ void sendPingWithAutoIncrement(void)
 {
   unsigned char responseBuffer[1];
 
+#ifdef EVOLUX
+  char ldt = 1 << deviceType;
+  // advance to the first matching device type
+  while (!(ldt & logicalDeviceTypeChoices[logicalDeviceTypeChoicesIndex][0]))
+    logicalDeviceTypeChoicesIndex++;
+#endif
   printk("[CEC] sendPingWithAutoIncrement - 1\n");
   setIsFirstKiss(1);
 
+#ifdef EVOLUX
+  logicalDeviceType = logicalDeviceTypeChoices[logicalDeviceTypeChoicesIndex++][1];
+#else
   logicalDeviceType = logicalDeviceTypeChoices[logicalDeviceTypeChoicesIndex++];
+#endif
   responseBuffer[0] = (logicalDeviceType << 4) + (logicalDeviceType & 0xF);
   printk("[CEC] sendPingWithAutoIncrement - 2\n");
   sendMessage(1, responseBuffer);
   printk("[CEC] sendPingWithAutoIncrement - 3\n");
+#ifdef EVOLUX
+  // advance to the next matching device type
+  while (!(ldt & logicalDeviceTypeChoices[logicalDeviceTypeChoicesIndex][0]))
+    logicalDeviceTypeChoicesIndex++;
+#endif
 }
 
 void sendOneTouchPlay(void)
diff --git a/cec/cec_opcodes_def.h b/cec/cec_opcodes_def.h
index 8836db4..2e55ca6 100644
--- a/cec/cec_opcodes_def.h
+++ b/cec/cec_opcodes_def.h
@@ -149,7 +149,14 @@
 #define USER_CONTROL_CODE_NUMBERS_8     0x28
 #define USER_CONTROL_CODE_NUMBERS_9     0x29
 
+#ifdef EVOLUX
+#define USER_CONTROL_CODE_PAGEUP	0x30
+#define USER_CONTROL_CODE_PAGEDOWN	0x31
+#endif
 #define USER_CONTROL_CODE_PREV_CHANNEL  0x32
+#ifdef EVOLUX
+#define USER_CONTROL_CODE_INFO		0x35
+#endif
 #define USER_CONTROL_CODE_EPG           0x53
 
 #define USER_CONTROL_CODE_F1_BLUE       0x71
@@ -164,6 +171,10 @@
 #define USER_CONTROL_CODE_RECORD        0x47
 #define USER_CONTROL_CODE_REWIND        0x48
 #define USER_CONTROL_CODE_FASTFORWARD   0x49
+#ifdef EVOLUX
+#define USER_CONTROL_CODE_NEXT		0x4B
+#define USER_CONTROL_CODE_LAST		0x4C
+#endif
 
 #define USER_CONTROL_CODE_FUNCTION_PLAY               0x60
 #define USER_CONTROL_CODE_FUNCTION_PAUSEPLAY          0x61
diff --git a/cec/cec_rc.c b/cec/cec_rc.c
index cc6359d..33e4d87 100644
--- a/cec/cec_rc.c
+++ b/cec/cec_rc.c
@@ -101,7 +101,21 @@ int input_inject(unsigned int key, unsigned int type)
 	case USER_CONTROL_CODE_PAUSE: code = KEY_PAUSE; break;
 	case USER_CONTROL_CODE_RECORD: code = KEY_RECORD; break;
 	case USER_CONTROL_CODE_REWIND: code = KEY_REWIND; break;
+#ifdef EVOLUX
 	case USER_CONTROL_CODE_FASTFORWARD: code = KEY_FASTFORWARD; break;
+#else
+	case USER_CONTROL_CODE_FASTFORWARD: code = KEY_FORWARD; break;
+#endif
+#ifdef EVOLUX
+	case USER_CONTROL_CODE_ROOT_MENU: code = KEY_MENU; break;
+	case USER_CONTROL_CODE_CONTENTS_MENU: code = KEY_FAVORITES; break;
+	case USER_CONTROL_CODE_SETUP_MENU: code = KEY_MENU; break;
+	case USER_CONTROL_CODE_NEXT: code = KEY_NEXT; break;
+	case USER_CONTROL_CODE_LAST: code = KEY_LAST; break;
+	case USER_CONTROL_CODE_PAGEUP: code = KEY_PAGEUP; break;
+	case USER_CONTROL_CODE_PAGEDOWN: code = KEY_PAGEDOWN; break;
+	case USER_CONTROL_CODE_INFO: code = KEY_INFO; break;
+#endif
 	default: break;
 	}
 
diff --git a/e2_proc/e2_proc_main.c b/e2_proc/e2_proc_main.c
index 728bb6a..cab9799 100644
--- a/e2_proc/e2_proc_main.c
+++ b/e2_proc/e2_proc_main.c
@@ -623,7 +623,7 @@ struct ProcStructure_s e2Proc[] =
 	{cProcEntry, "stb/video/plane/psi_contrast"    , NULL, NULL, NULL, NULL, "psi_contrast"},
 	{cProcEntry, "stb/video/plane/psi_tint"        , NULL, NULL, NULL, NULL, "psi_tint"},
 	{cProcEntry, "stb/video/plane/psi_apply"        , NULL, NULL, NULL, NULL, "psi_apply"},
-#if defined(UFS912) || defined(UFS913) || defined(ATEVIO7500)
+#if defined(UFS912) || defined(UFS913) || defined(ATEVIO7500) || defined(SPARK)
 	{cProcDir  , "stb/cec"   	                   , NULL, NULL, NULL, NULL, ""},
 	{cProcEntry, "stb/cec/state_activesource"   	               , NULL, NULL, NULL, NULL, ""},
 	{cProcEntry, "stb/cec/state_standby"   	               , NULL, NULL, NULL, NULL, ""},
-- 
1.7.7

